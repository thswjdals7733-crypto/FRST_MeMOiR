<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <!-- 데스크탑/모바일 모두 동일 렌더링을 위한 뷰포트 고정 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <title>Memoir Base (390 Lock)</title>

  <!-- 폰트: Pretendard + Noto Sans KR (간편 사용용 CDN). 실제 배포는 /fonts 에 WOFF2 직접호스팅 권장 -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@200;300;400;700&display=swap" />

  <style>
    /* -----------------------------
       0) DESIGN TOKENS (폰트/색/크기)
    ----------------------------- */
    :root {
      /* Fonts */
      --ff-primary: 'Pretendard', 'Noto Sans KR', system-ui, sans-serif;

      /* Font Sizes */
      --fs-web-title: 6.5rem;   /* 104px - 웹 타이틀 */
      --fs-header: 2.25rem;        /* 36px - 섹션 헤더 */
      --fs-subtitle-large: 1.25rem;/* 20px - 소주제 */
      --fs-number: 1.875rem;       /* 30px - 숫자 */
      --fs-body: 1rem;             /* 16px - 본문 */
      --fs-caption: 0.875rem;      /* 14px - 주석 */

      /* Weights */
      --fw-thin: 200;
      --fw-light: 300;
      --fw-regular: 400;
      --fw-bold: 700;

      /* Line Heights */
      --lh-tight: 1.1;
      --lh-snug: 1.25;
      --lh-normal: 1.5;

      /* Colors (sRGB/HEX 고정) */
      --c-point: #0459F0;                 /* 포인트 */
      --c-section-header: #022669;        /* 섹션 헤더 */
      --c-text-main: #111827;             /* 기본 본문 */
      --c-text-sub: #1F2937;              /* 일반 텍스트/이름 */
      --c-text-note: #6B7280;             /* 주석 */
      --c-bg-card: #FFFFFF;               /* 카드/바탕 */
      --c-bg-scroll-track: #F7FAFC;       /* 스크롤 트랙 */
      --c-bg-scroll-thumb: #CBD5E0;       /* 스크롤 썸 */
      --c-nav-bg-default: #E5E7EB;        /* 네비 기본 배경 */
      --c-nav-text-default: #1F2937;      /* 네비 기본 텍스트 */
      --c-nav-bg-active: #0459F0;         /* 네비 활성 배경 */
      --c-nav-text-active: #FFFFFF;       /* 네비 활성 텍스트 */
    }

    /* -----------------------------
       1) GLOBAL BASE (렌더링 고정)
    ----------------------------- */
    html, body {
      margin: 0;
      padding: 0;
      background: var(--c-bg-card);
      color: var(--c-text-main);
      font-family: var(--ff-primary);
      font-synthesis: none;                  /* 가짜 Bold/Italic 합성 금지 */
      -webkit-font-smoothing: antialiased;   /* 렌더링 안정화 */
      -moz-osx-font-smoothing: grayscale;
      -webkit-text-size-adjust: 100%;        /* iOS 자동확대 방지 */
      text-wrap: pretty;
      min-height: 100dvh;
      overflow: hidden;                      /* 스케일 루트에서 스크롤 */
    }
    * { text-rendering: optimizeLegibility; }
    :lang(ko) { word-break: keep-all; }
    h1,h2,h3 { text-wrap: balance; margin: 0; }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: var(--c-bg-scroll-track); }
    ::-webkit-scrollbar-thumb { background: var(--c-bg-scroll-thumb); border-radius: 3px; }

    img { max-width: 100%; height: auto; display: block; image-rendering: auto; }

    /* -----------------------------
       2) 390px 고정 캔버스 (Web-lock)
    ----------------------------- */
    .embed-root {
      width: 100vw;
      height: 100dvh;                /* 화면 가득 */
      display: flex;
      justify-content: center;       /* 데스크탑에서 가운데 정렬 */
      align-items: flex-start;       /* 긴 페이지 스크롤 고려 (필요 시 center) */
      overflow: auto;
      background: #F7FAFC;
    }
    .embed-stage {
      width: 390px;                  /* 기준 폭 고정 */
      transform-origin: top left;
      backface-visibility: hidden;
      box-sizing: border-box;
      padding: 24px;

      /* 미리보기 품질 향상(선택) */
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    /* -----------------------------
       3) 타이포 유틸리티
    ----------------------------- */
    .text-web-title { font-size: var(--fs-web-title); line-height: var(--lh-tight); font-weight: var(--fw-bold); color: var(--c-section-header); }
    .k-header       { font-size: var(--fs-header);    line-height: var(--lh-tight); font-weight: var(--fw-bold); color: var(--c-section-header); }
    .k-sub          { font-size: var(--fs-subtitle-large); line-height: var(--lh-snug);   font-weight: var(--fw-light); color: var(--c-text-sub); }
    .k-body         { font-size: var(--fs-body);      line-height: var(--lh-normal); font-weight: var(--fw-light); color: var(--c-text-main); }
    .k-note         { font-size: var(--fs-caption);   line-height: var(--lh-normal); font-weight: var(--fw-light); color: var(--c-text-note); }
    .k-num          { font-size: var(--fs-number);    line-height: var(--lh-snug);   font-weight: var(--fw-bold);  color: var(--c-point); }

    .nowrap-chunk { white-space: nowrap; display: inline-block; }
    .can-break    { overflow-wrap: anywhere; word-break: break-word; hyphens: auto; }
    .hr           { height: 2px; background: #e5e7eb; margin: 24px 0; }

    /* -----------------------------
       4) 텍스트 박스(tbox) 유틸
         - 가로/세로 중앙정렬
         - 프리셋 크기/커스텀 크기
    ----------------------------- */
    .tbox {
      display: flex;
      justify-content: center; align-items: center;   /* 중앙정렬 */
      text-align: center; line-height: var(--lh-normal);
      width: var(--tb-w, auto); height: var(--tb-h, auto);
      padding: var(--tb-p, 0); box-sizing: border-box;
      overflow: hidden;                                /* 필요 시 visible */
      font-style: normal;                              /* UA 기울임 방지 */
    }
    .tbox p, .tbox span, .tbox div { margin: 0; }
    .tbox.nowrap { white-space: nowrap; }
    .tbox.can-break { overflow-wrap: anywhere; word-break: break-word; hyphens: auto; }
    .tbox.round { border-radius: 12px; }
    .tbox.debug { outline: 1px dashed #CBD5E0; background: rgba(4,89,240,0.02); }

    /* tbox 크기 프리셋 */
    .tbox-xs { --tb-w:120px; --tb-h:32px; }
    .tbox-sm { --tb-w:160px; --tb-h:48px; }
    .tbox-md { --tb-w:240px; --tb-h:72px; }
    .tbox-lg { --tb-w:300px; --tb-h:96px; }
    .tbox-xl { --tb-w:360px; --tb-h:120px; }

    /* 폼: iOS 자동줌 방지 */
    input, textarea, select { font-size: 16px; }
  </style>
</head>

<body>
  <!-- 스케일 루트 -->
  <div class="embed-root">
    <div class="embed-stage" id="stage">
      <!-- 웹 제목 -->
      <h1 class="text-web-title" style="text-align: center; margin: 0; padding: 1.5rem 0; font-style: italic !important; letter-spacing: -0.02em; line-height: 1.2;">
        2025<br>memoir
      </h1>
      <!-- 여기(#stage)에 텍스트를 그냥 붙여넣으면 자동으로 중앙정렬 박스로 변환됨 -->
      <!-- 예: [h1] 2025 memoir  /  [h2] 섹션 타이틀  /  [body] 본문 한 단락 ... -->
    </div>
  </div>

  <!-- 5) 스케일/높이 재계산: 데스크탑은 1배, 좁은 화면에선 축소 -->
  <script>
    const DESIGN = 390;
    const root   = document.querySelector(".embed-root");
    const stage  = document.getElementById("stage");

    function rescale() {
      const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      const scale = Math.min(vw, DESIGN) / DESIGN;     // 데스크탑=1, 모바일/좁은 임베드<1
      stage.style.transform = `scale(${scale})`;
      const scaledH = stage.offsetHeight * scale;
      root.style.height = Math.max(scaledH, window.innerHeight) + "px";
    }
    window.addEventListener("load", rescale);
    window.addEventListener("resize", rescale);
    window.visualViewport?.addEventListener("resize", rescale);
    window.addEventListener("orientationchange", rescale);
  </script>

  <!-- 6) 자동 텍스트 박스 생성 + 프리픽스 파서 + 카드 인덱싱 -->
  <script>
    // 기본 자동 박스 클래스(모바일 큰 타이틀 톤으로 시작: 필요 시 'k-body'로 변경)
    const TBOX_CLASS = "tbox k-header can-break";

    // [h1]/[h2]/[body]/[note]/[num] 프리픽스 → 클래스 매핑
    function classFromPrefix(text) {
      const t = text.trim();
      if (t.startsWith("[h1]"))  return ["text-web-title", t.replace("[h1]","").trim()];
      if (t.startsWith("[h2]"))  return ["k-header",        t.replace("[h2]","").trim()];
      if (t.startsWith("[body]"))return ["k-body",          t.replace("[body]","").trim()];
      if (t.startsWith("[note]"))return ["k-note",          t.replace("[note]","").trim()];
      if (t.startsWith("[num]")) return ["k-num",           t.replace("[num]","").trim()];
      return [null, t];
    }

    const IGNORE_PARENTS = new Set(["SCRIPT","STYLE","TITLE","NOSCRIPT"]);
    function wrapTextNode(textNode) {
      const raw = textNode.nodeValue;
      if (!raw || !raw.trim()) return;

      const parent = textNode.parentNode;
      if (!parent || parent.closest(".tbox") || IGNORE_PARENTS.has(parent.nodeName) || parent.nodeName === "H1") return;

      // 공백 정리
      const normalized = raw.replace(/\s+/g, " ").trim();
      const [extraClass, plain] = classFromPrefix(normalized);

      const box = document.createElement("div");
      box.className = TBOX_CLASS + (extraClass ? (" " + extraClass) : "");
      box.style.setProperty("--tb-p","8px");       // 기본 패딩
      box.textContent = plain;

      parent.insertBefore(box, textNode);
      parent.removeChild(textNode);
    }

    function wrapElementIfPlain(el) {
      if (el.closest(".tbox")) return;
      if (IGNORE_PARENTS.has(el.nodeName)) return;

      const onlyText = Array.from(el.childNodes).every(n => n.nodeType === 3 || n.nodeType === 8);
      const text = el.textContent ?? "";
      if (onlyText && text.trim()) {
        const [extraClass, plain] = classFromPrefix(text);
        const box = document.createElement("div");
        box.className = TBOX_CLASS + (extraClass ? (" " + extraClass) : "");
        box.style.setProperty("--tb-p","8px");
        box.textContent = plain.replace(/\s+/g, " ").trim();
        el.replaceWith(box);
      }
    }

    function applyAutoTbox(rootEl = stage) {
      if (!rootEl) return;

      // 1) 텍스트 노드 → tbox
      const walker = document.createTreeWalker(rootEl, NodeFilter.SHOW_TEXT, {
        acceptNode(node) {
          if (!node.nodeValue || !node.nodeValue.trim()) return NodeFilter.FILTER_REJECT;
          const p = node.parentNode;
          if (!p || IGNORE_PARENTS.has(p.nodeName) || p.closest(".tbox")) return NodeFilter.FILTER_REJECT;
          return NodeFilter.FILTER_ACCEPT;
        }
      });
      const textNodes = [];
      while (walker.nextNode()) textNodes.push(walker.currentNode);
      textNodes.forEach(wrapTextNode);

      // 2) 텍스트만 가진 엘리먼트 → 통째로 tbox (h1은 제외)
      rootEl.querySelectorAll("p,h2,h3,h4,div,span").forEach(wrapElementIfPlain);

      // 3) 인덱싱(data-index) 부여
      numberTboxes();
      // 4) 높이 재계산
      requestAnimationFrame(rescale);
    }

    function numberTboxes() {
      document.querySelectorAll("#stage .tbox").forEach((box, i) => {
        box.dataset.index = i + 1; // data-index="1", "2", ...
      });
    }

    // 초기 적용 + 변경 감지
    window.addEventListener("DOMContentLoaded", () => applyAutoTbox());
    const mo = new MutationObserver(muts => {
      for (const m of muts) {
        m.addedNodes.forEach(n => {
          if (n.nodeType === 3) wrapTextNode(n);          // 텍스트 노드
          else if (n.nodeType === 1) applyAutoTbox(n);    // 엘리먼트
        });
      }
    });
    mo.observe(stage, { childList: true, subtree: true });
  </script>
</body>
</html>
